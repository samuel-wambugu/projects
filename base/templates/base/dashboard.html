{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
        {% if request.user.is_superuser %}
    <!-- Admin Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Admin Controls</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Upload Tutorial Video</h5>
                                    <form action="{% url 'upload_video' %}" method="post" enctype="multipart/form-data" id="videoUploadForm">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <input type="text" class="form-control mb-2" id="title" name="title"
                                                placeholder="Enter video title" required>

                                            <input type="file" class="form-control mb-2" id="videoInput" name="video"
                                                accept="video/*" required>

                                            <!-- Level dropdown -->
                                            <select class="form-select mb-2" id="level" name="level" required>
                                                <option value="">-- Select Level --</option>
                                                <option value="beginner">Beginner</option>
                                                <option value="intermediate">Intermediate</option>
                                                <option value="advanced">Advanced</option>
                                            </select>

                                            <!-- Free access checkbox -->
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="free_access" name="free_access">
                                                <label class="form-check-label" for="free_access">
                                                    Free Access
                                                </label>
                                            </div>

                                            <div class="d-flex gap-2">
                                                <button type="button" class="btn btn-primary" onclick="preview()">
                                                    <i class="fas fa-eye me-1"></i> Preview
                                                </button>
                                                <button type="submit" class="btn btn-success">
                                                    <i class="fas fa-upload me-1"></i> Upload
                                                </button>
                                                <button type="button" class="btn btn-danger" onclick="deletePreview()">
                                                    <i class="fas fa-trash me-1"></i> Discard
                                                </button>
                                            </div>
                                        </div>
                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Video Preview</h5>
                </div>
                <div class="card-body">
                    <video id="videoPreview" class="w-100" controls></video>
                </div>
            </div>
        </div>
    </div>

     <div class="row g-4">

        <div class="col-12">
            <h2 class="mb-3">Your Tutorials</h2>
        </div>
        {% for tutorial in tutorials %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{tutorial.title}}</h5>
                    <p class="card-text">{{tutorial.content|truncatewords:30}}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">{{tutorial.get_level_display}}</span>
                        {% if tutorial.free_access or subscription %}
                            <button class="btn btn-outline-primary" onclick="playVideo('{{ tutorial.id }}')">Start Learning</button>
                            <div id="videoContainer{{ tutorial.id }}" class="mt-3" style="display:none;">
                                <video class="w-100" controls autoplay>
                                    <source src="{{ tutorial.videos.url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        {% else %}
                            <a href="{% url 'subscription_plans' %}" class="btn btn-outline-warning">
                                <i class="fas fa-lock me-1"></i> Premium Content
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}



    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">Welcome back, {{ user.fullname }}!</h4>
                            <p class="mb-0">
                                {% if subscription %}
                                    <i class="fas fa-crown text-warning"></i> 
                                    Premium member until {{ subscription.end_date|date:"F j, Y" }}
                                {% else %}
                                    <a href="{% url 'subscription_plans' %}" class="btn btn-outline-light btn-sm">
                                        <i class="fas fa-crown"></i> Upgrade to Premium
                                    </a>
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-1">Your Progress</h5>
                            <div class="progress bg-white bg-opacity-25" style="height: 10px; width: 200px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     data-progress="{{ progress_percentage|default:0|floatformat:1 }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <small>{{ progress_percentage|default:0|floatformat:1 }}% Complete</small>
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const progressBar = document.querySelector('[data-progress]');
                                    const progress = progressBar.getAttribute('data-progress');
                                    progressBar.style.width = progress + '%';
                                    progressBar.setAttribute('aria-valuenow', progress);
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <!-- Tutorials Completed -->
        <div class="col-md-4">
            <div class="card stats-card h-100">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Tutorials Completed</h6>
                            <h2 class="mb-0">{{ completed_tutorials }} / {{ total_tutorials }}</h2>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Performance -->
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Recent Activity</h6>
                            <h2 class="mb-0">{{ recent_tutorials_count|default:0 }}</h2>
                            <small>Tutorials this week</small>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Status -->
        <div class="col-md-4">
            <div class="card h-100" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Subscription Status</h6>
                            <h2 class="mb-0">
                                {% if subscription %}
                                    Premium
                                {% else %}
                                    Free
                                {% endif %}
                            </h2>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-crown fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Currency Pairs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Live Currency Pairs</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Pair</th>
                                    <th>Current Rate</th>
                                    <th>Daily High</th>
                                    <th>Daily Low</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pair in currency_pairs %}
                                <tr>
                                    <td>{{ pair.base_currency }}/{{ pair.quote_currency }}</td>
                                    <td>{{ pair.current_rate }}</td>
                                    <td>{{ pair.daily_high }}</td>
                                    <td>{{ pair.daily_low }}</td>
                                    <td>
                                        <span class="{% if pair.daily_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ pair.daily_change }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial List -->
    <div class="row g-4">
        {% for tutorial in tutorials %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{tutorial.title}}</h5>
                    <p class="card-text">{{tutorial.content|truncatewords:30}}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary">{{tutorial.get_level_display}}</span>
                        {% if tutorial.free_access or subscription %}
                            <a href="{% url 'tutorial_detail' tutorial.id %}" class="btn btn-outline-primary">Start Learning</a>
                        {% else %}
                            <a href="{% url 'subscription_plans' %}" class="btn btn-outline-warning">
                                <i class="fas fa-lock me-1"></i> Premium Content
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Video List -->
    {% if video %}
    <div class="row g-4 mt-4">
        <div class="col-12">
            <h4 class="mb-3">Available Videos</h4>
        </div>
        {% for v in video %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <video class="w-100 mb-3" controls poster="{{v.images.url}}" preload="metadata">
                        <source src="{{v.videos.url}}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <h5 class="card-title">{{v.title}}</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        {% if request.user.is_superuser %}
                            <form action="{% url 'delete_video' v.id %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this video?')">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                            </form>
                        {% endif %}
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#videoModal{{v.id}}">
                            <i class="fas fa-expand me-1"></i> Full Screen
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endif %}


</div>

<!-- Video Modals -->
{% if video %}
    {% for v in video %}
    <div class="modal fade" id="videoModal{{v.id}}" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{v.title}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <video class="w-100" controls poster="{{v.images.url}}" preload="metadata">
                        <source src="{{v.videos.url}}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}
{% endblock content %}