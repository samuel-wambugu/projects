{% extends 'main.html' %}
{% load static %}

{% block extra_css %}
<style>
    .text-truncate-2-lines {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
        max-height: calc(2 * 1.3em);
    }
    
    .tutorial-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .tutorial-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .card-img-overlay-bottom {
        background: linear-gradient(transparent, rgba(0,0,0,0.6));
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    {% if user.is_superuser %}
    <!-- SUPERUSER DASHBOARD -->
    <!-- Welcome Section for Admin -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1"><i class="fas fa-shield-alt me-2"></i>Admin Dashboard</h4>
                            <p class="mb-0">Welcome back, {{ user.fullname }}! You have full system access.</p>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-1">System Status</h5>
                            <small><i class="fas fa-users me-1"></i>{{ total_users }} Total Users</small><br>
                            <small><i class="fas fa-play-circle me-1"></i>{{ total_tutorials }} Tutorials</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- REGULAR USER DASHBOARD -->
    <!-- Welcome Section for Regular Users -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">Welcome back, {{ user.fullname }}!</h4>
                            <p class="mb-0">
                                {% if subscription %}
                                    <i class="fas fa-crown text-warning"></i> 
                                    Premium member until {{ subscription.end_date|date:"F j, Y" }}
                                {% else %}
                                    <a href="{% url 'subscription_plans' %}" class="btn btn-outline-light btn-sm">
                                        <i class="fas fa-crown"></i> Upgrade to Premium
                                    </a>
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-1">Your Progress</h5>
                            <div class="progress bg-white bg-opacity-25" style="height: 10px; width: 200px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     data-progress="{{ progress_percentage|default:0|floatformat:1 }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <small>{{ progress_percentage|default:0|floatformat:1 }}% Complete</small>
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const progressBar = document.querySelector('[data-progress]');
                                    const progress = progressBar.getAttribute('data-progress');
                                    progressBar.style.width = progress + '%';
                                    progressBar.setAttribute('aria-valuenow', progress);
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Common sections for all users -->
    <div class="row g-4 mb-4">
        <!-- Trading Performance -->
        <div class="col-md-6">
            <div class="card h-100" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Recent Activity</h6>
                            <h2 class="mb-0">{{ recent_tutorials_count|default:0 }}</h2>
                            <small>Tutorials this week</small>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Status -->
        <div class="col-md-6">
            <div class="card h-100" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-2">Subscription Status</h6>
                            <h2 class="mb-0">
                                {% if subscription %}
                                    Premium
                                {% else %}
                                    Free
                                {% endif %}
                            </h2>
                        </div>
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-crown fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_superuser %}
    <!-- SUPERUSER STATS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h5 class="card-title">Total Users</h5>
                    <p class="card-text display-4">{{ total_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-crown fa-2x mb-2"></i>
                    <h5 class="card-title">Active Subscriptions</h5>
                    <p class="card-text display-4">{{ active_subscriptions }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h5 class="card-title">Completion Rate</h5>
                    <p class="card-text display-4">{{ avg_completion_rate|floatformat:1 }}%</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                    <h5 class="card-title">Total Earnings</h5>
                    <p class="card-text display-4">${{ total_earnings|default:0 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Superuser Quick Actions -->
    {% if user.is_superuser %}
        </div>

    <!-- Superuser Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3">
                        <a href="{% url 'create_tutorial' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Create New Tutorial
                        </a>
                        <a href="{% url 'tutorial_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>Manage All Tutorials
                        </a>
                        <a href="/admin/" class="btn btn-outline-dark" target="_blank">
                            <i class="fas fa-cog me-2"></i>Django Admin
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if not user.is_superuser %}
    <!-- REGULAR USER STATS -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-play-circle fa-2x mb-2"></i>
                    <h5 class="card-title">Total Tutorials</h5>
                    <p class="card-text display-4">{{ total_tutorials }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h5 class="card-title">Completed</h5>
                    <p class="card-text display-4">{{ completed_tutorials }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Regular User Tutorials Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Your Tutorials</h5>
                    <a href="{% url 'tutorial_list' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-list"></i> View All Tutorials
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for tutorial in tutorials|slice:":6" %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm border-0 tutorial-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="position-relative">
                                    {% if tutorial.thumbnail %}
                                        <img src="{{ tutorial.thumbnail.url }}" class="card-img-top" alt="{{ tutorial.title }}" style="height: 200px; object-fit: cover;">
                                    {% else %}
                                        <div class="d-flex align-items-center justify-content-center text-white" style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                            <div class="text-center">
                                                <i class="fas fa-play-circle fa-3x mb-2"></i>
                                                <div class="font-weight-bold">{{ tutorial.title|truncatechars:20 }}</div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <!-- Duration/Level overlay -->
                                    <div class="position-absolute bottom-0 end-0 m-2">
                                        <span class="badge bg-dark bg-opacity-75 text-white">{{ tutorial.level|capfirst }}</span>
                                    </div>
                                    <!-- Price overlay -->
                                    {% if tutorial.price > 0 %}
                                        <div class="position-absolute top-0 start-0 m-2">
                                            <span class="badge bg-warning text-dark font-weight-bold">${{ tutorial.price|floatformat:2 }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-body d-flex flex-column p-3">
                                    <h6 class="card-title mb-2 font-weight-bold text-truncate-2-lines">
                                        {{ tutorial.title|truncatechars:50 }}
                                    </h6>
                                    <p class="card-text small text-muted mb-3 text-truncate-2-lines">
                                        {{ tutorial.content|truncatewords:15 }}
                                    </p>
                                    <div class="mt-auto d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            {% if user.is_superuser %}
                                                <span class="badge bg-info me-2">Admin</span>
                                                <a href="{% url 'tutorial_detail' tutorial.id %}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-play me-1"></i>Watch
                                                </a>
                                            {% elif tutorial.price > 0 %}
                                                {% if subscription %}
                                                    <span class="badge bg-success me-2">Included</span>
                                                    <a href="{% url 'tutorial_detail' tutorial.id %}" class="btn btn-primary btn-sm">
                                                        <i class="fas fa-play me-1"></i>Watch
                                                    </a>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark font-weight-bold">${{ tutorial.price|floatformat:2 }}</span>
                                                    <a href="{% url 'tutorial_detail' tutorial.id %}" class="btn btn-outline-warning btn-sm">
                                                        <i class="fas fa-shopping-cart me-1"></i>Purchase
                                                    </a>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-success me-2">Free</span>
                                                <a href="{% url 'tutorial_detail' tutorial.id %}" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-play me-1"></i>Watch
                                                </a>
                                            {% endif %}
                                        </div>
                                        <!-- Tutorial metadata -->
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ tutorial.created_at|date:"M d" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if user.is_superuser %}
    <!-- Tutorial Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Tutorial Management</h5>
                    <a href="{% url 'create_tutorial' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-plus"></i> Add New Tutorial
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Title</th>
                                    <th>Completions</th>
                                    <th>Completion Rate</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in tutorial_stats %}
                                <tr>
                                    <td>
                                        <a href="{% url 'tutorial_detail' stat.tutorial.id %}" class="text-decoration-none">
                                            {{ stat.tutorial.title }}
                                        </a>
                                    </td>
                                    <td><span class="badge bg-info">{{ stat.completions }}</span></td>
                                    <td>
                                        <div class="progress" style="width: 100px; height: 20px;">
                                            <div class="progress-bar bg-primary tutorial-progress" role="progressbar" 
                                                 data-completion-rate="{{ stat.completion_rate|floatformat:1 }}"
                                                 aria-valuenow="{{ stat.completion_rate|floatformat:1 }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ stat.completion_rate|floatformat:1 }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if stat.tutorial.price > 0 %}
                                            <span class="text-success">${{ stat.tutorial.price }}</span>
                                        {% else %}
                                            <span class="badge bg-success">FREE</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'tutorial_detail' stat.tutorial.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTutorialModal{{ stat.tutorial.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Delete Confirmation Modal -->
                                        <div class="modal fade" id="deleteTutorialModal{{ stat.tutorial.id }}" tabindex="-1" aria-labelledby="deleteTutorialModalLabel{{ stat.tutorial.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-danger text-white">
                                                        <h5 class="modal-title" id="deleteTutorialModalLabel{{ stat.tutorial.id }}">
                                                            <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                                                        </h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Are you sure you want to delete <strong>"{{ stat.tutorial.title }}"</strong>?</p>
                                                        <div class="alert alert-warning">
                                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                                            This action cannot be undone and will remove all user progress for this tutorial.
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="button" class="btn btn-danger delete-tutorial-btn" 
                                                                data-tutorial-id="{{ stat.tutorial.id }}"
                                                                data-modal-id="deleteTutorialModal{{ stat.tutorial.id }}">
                                                            <i class="fas fa-trash me-1"></i>Delete Tutorial
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Video List -->
    {% if video %}
    <div class="row g-4 mt-4">
        <div class="col-12">
            <h4 class="mb-3">Available Videos</h4>
        </div>
        {% for v in video %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <video class="w-100 mb-3" controls poster="{{v.images.url}}" preload="metadata">
                        <source src="{{v.videos.url}}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <h5 class="card-title">{{v.title}}</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        {% if request.user.is_superuser %}
                            <form action="{% url 'delete_video' v.id %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this video?')">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                            </form>
                        {% endif %}
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#videoModal{{v.id}}">
                            <i class="fas fa-expand me-1"></i> Full Screen
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Currency Pairs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Live Currency Pairs</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Pair</th>
                                    <th>Current Rate</th>
                                    <th>Daily High</th>
                                    <th>Daily Low</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pair in currency_pairs %}
                                <tr>
                                    <td>{{ pair.base_currency }}/{{ pair.quote_currency }}</td>
                                    <td>{{ pair.current_rate }}</td>
                                    <td>{{ pair.daily_high }}</td>
                                    <td>{{ pair.daily_low }}</td>
                                    <td>
                                        <span class="{% if pair.daily_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ pair.daily_change }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 text-center">
        <a href="{% url 'logout' %}" class="btn btn-outline-danger">
            <i class="fas fa-sign-out-alt me-1"></i> Logout
        </a>
    </div>
</div>

<!-- Video Modals -->
{% if video %}
    {% for v in video %}
    <div class="modal fade" id="videoModal{{v.id}}" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{v.title}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <video class="w-100" controls poster="{{v.images.url}}" preload="metadata">
                        <source src="{{v.videos.url}}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

{% endblock content %}

{% block extra_js %}
{% if user.is_superuser %}
<script>
// Initialize tutorial progress bars
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.tutorial-progress');
    progressBars.forEach(function(bar) {
        const completionRate = bar.getAttribute('data-completion-rate');
        bar.style.width = completionRate + '%';
    });
});
</script>
{% endif %}

{% endblock %}