{% extends 'main.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create New{% endif %} Tutorial - Forex Academy{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %} me-2"></i>
                            {% if form.instance.pk %}Edit{% else %}Create New{% endif %} Tutorial
                        </h4>
                        <div class="text-end">
                            <small>
                                <i class="fas fa-user me-1"></i>
                                {{ user.fullname|default:user.username }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="tutorialForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information Section -->
                        <div class="section-header mb-4">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="fas fa-info-circle me-2"></i>
                                Basic Information
                            </h5>
                        </div>
                        
                        <div class="row">
                            <!-- Title -->
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold">
                                    <i class="fas fa-heading text-primary me-1"></i>
                                    Tutorial Title *
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       name="{{ form.title.name }}" 
                                       id="{{ form.title.id_for_label }}"
                                       value="{{ form.title.value|default:'' }}"
                                       placeholder="Enter an engaging tutorial title..."
                                       required>
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Make it descriptive and engaging for students</div>
                            </div>
                            
                            <!-- Order -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.order.id_for_label }}" class="form-label fw-semibold">
                                    <i class="fas fa-sort-numeric-up text-warning me-1"></i>
                                    Display Order
                                </label>
                                <input type="number" class="form-control" 
                                       name="{{ form.order.name }}" 
                                       id="{{ form.order.id_for_label }}"
                                       value="{{ form.order.value|default:'' }}"
                                       min="1" max="1000">
                                {% if form.order.errors %}
                                    <div class="invalid-feedback d-block">{{ form.order.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Lower numbers appear first</div>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="mb-4">
                            <label for="{{ form.content.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-align-left text-info me-1"></i>
                                Tutorial Description *
                            </label>
                            <textarea class="form-control" 
                                      name="{{ form.content.name }}" 
                                      id="{{ form.content.id_for_label }}"
                                      rows="6"
                                      placeholder="Describe what students will learn in this tutorial..."
                                      required>{{ form.content.value|default:'' }}</textarea>
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Provide a clear overview of the tutorial content and learning objectives</div>
                        </div>

                        <!-- Media Section -->
                        <div class="section-header mb-4 mt-5">
                            <h5 class="text-success border-bottom pb-2">
                                <i class="fas fa-photo-video me-2"></i>
                                Media Files
                            </h5>
                        </div>

                        <div class="row">
                            <!-- Thumbnail -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.thumbnail.id_for_label }}" class="form-label fw-semibold">
                                    <i class="fas fa-image text-success me-1"></i>
                                    Thumbnail Image
                                </label>
                                <input type="file" class="form-control" 
                                       name="{{ form.thumbnail.name }}" 
                                       id="{{ form.thumbnail.id_for_label }}"
                                       accept="image/*">
                                {% if form.thumbnail.errors %}
                                    <div class="invalid-feedback d-block">{{ form.thumbnail.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Upload an attractive thumbnail (JPG, PNG, max 5MB)</div>
                                <div id="thumbnailPreview" class="mt-2"></div>
                            </div>

                            <!-- Video -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.video.id_for_label }}" class="form-label fw-semibold">
                                    <i class="fas fa-video text-danger me-1"></i>
                                    Video File
                                </label>
                                <input type="file" class="form-control" 
                                       name="{{ form.video.name }}" 
                                       id="{{ form.video.id_for_label }}"
                                       accept="video/*">
                                {% if form.video.errors %}
                                    <div class="invalid-feedback d-block">{{ form.video.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Upload video file (MP4, WebM, max 500MB)</div>
                            </div>
                        </div>

                        <!-- Video URL Alternative -->
                        <div class="mb-4">
                            <label for="{{ form.video_url.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-link text-info me-1"></i>
                                Or Video URL (YouTube, Vimeo, etc.)
                            </label>
                            <input type="url" class="form-control" 
                                   name="{{ form.video_url.name }}" 
                                   id="{{ form.video_url.id_for_label }}"
                                   value="{{ form.video_url.value|default:'' }}"
                                   placeholder="https://youtube.com/watch?v=...">
                            {% if form.video_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.video_url.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Use this if you prefer hosting video externally</div>
                        </div>

                        <!-- Pricing & Access Section -->
                        <div class="section-header mb-4 mt-5">
                            <h5 class="text-warning border-bottom pb-2">
                                <i class="fas fa-dollar-sign me-2"></i>
                                Pricing & Access
                            </h5>
                        </div>

                        <div class="row">
                            <!-- Free Access Toggle -->
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="{{ form.free_access.name }}" 
                                                   id="{{ form.free_access.id_for_label }}"
                                                   {% if form.free_access.value %}checked{% endif %}>
                                            <label class="form-check-label fw-semibold" for="{{ form.free_access.id_for_label }}">
                                                <i class="fas fa-unlock text-success me-1"></i>
                                                Make this tutorial FREE
                                            </label>
                                        </div>
                                        <small class="text-muted">Toggle this to make the tutorial accessible to all users</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Price -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.price.id_for_label }}" class="form-label fw-semibold">
                                    <i class="fas fa-money-bill-wave text-warning me-1"></i>
                                    Price (USD)
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-warning text-dark">$</span>
                                    <input type="number" class="form-control" 
                                           name="{{ form.price.name }}" 
                                           id="{{ form.price.id_for_label }}"
                                           value="{{ form.price.value|default:'0.00' }}"
                                           min="0" step="0.01"
                                           placeholder="0.00">
                                </div>
                                {% if form.price.errors %}
                                    <div class="invalid-feedback d-block">{{ form.price.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Set to 0 for free tutorials</div>
                            </div>
                        </div>

                        <!-- Tutorial Settings Section -->
                        <div class="section-header mb-4 mt-5">
                            <h5 class="text-info border-bottom pb-2">
                                <i class="fas fa-cogs me-2"></i>
                                Tutorial Settings
                            </h5>
                        </div>

                        <!-- Level -->
                        <div class="mb-4">
                            <label for="{{ form.level.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-layer-group text-info me-1"></i>
                                Difficulty Level
                            </label>
                            <select class="form-select form-select-lg" 
                                    name="{{ form.level.name }}" 
                                    id="{{ form.level.id_for_label }}">
                                <option value="">Select difficulty level...</option>
                                <option value="beginner" {% if form.level.value == 'beginner' %}selected{% endif %}>
                                    ðŸŸ¢ Beginner - New to trading
                                </option>
                                <option value="intermediate" {% if form.level.value == 'intermediate' %}selected{% endif %}>
                                    ðŸŸ¡ Intermediate - Some experience
                                </option>
                                <option value="advanced" {% if form.level.value == 'advanced' %}selected{% endif %}>
                                    ðŸ”´ Advanced - Experienced traders
                                </option>
                            </select>
                            {% if form.level.errors %}
                                <div class="invalid-feedback d-block">{{ form.level.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Help students choose appropriate content for their skill level</div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 justify-content-between align-items-center mt-5 pt-4 border-top">
                            <div>
                                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                </a>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-warning" onclick="previewTutorial()">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </button>
                                <button type="submit" class="btn btn-success btn-lg px-4">
                                    <i class="fas fa-save me-2"></i>
                                    {% if form.instance.pk %}Update{% else %}Create{% endif %} Tutorial
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar with Tips -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Tutorial Creation Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="tips-section">
                        <h6 class="text-primary">
                            <i class="fas fa-star text-warning me-1"></i>
                            Best Practices
                        </h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Use clear, descriptive titles
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Include learning objectives
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Add engaging thumbnails
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Set appropriate pricing
                            </li>
                        </ul>
                    </div>
                    
                    <hr>
                    
                    <div class="tips-section">
                        <h6 class="text-warning">
                            <i class="fas fa-video me-1"></i>
                            Video Guidelines
                        </h6>
                        <ul class="list-unstyled small text-muted">
                            <li>â€¢ Max file size: 500MB</li>
                            <li>â€¢ Supported formats: MP4, WebM</li>
                            <li>â€¢ Recommended resolution: 1080p</li>
                            <li>â€¢ Duration: 10-30 minutes</li>
                        </ul>
                    </div>
                    
                    <hr>
                    
                    <div class="tips-section">
                        <h6 class="text-info">
                            <i class="fas fa-image me-1"></i>
                            Thumbnail Guidelines
                        </h6>
                        <ul class="list-unstyled small text-muted">
                            <li>â€¢ Recommended size: 1280x720</li>
                            <li>â€¢ Max file size: 5MB</li>
                            <li>â€¢ Formats: JPG, PNG</li>
                            <li>â€¢ Use bright, clear images</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Tutorial Stats -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Quick Stats
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 border-end">
                            <h4 class="text-primary mb-0">{{ total_tutorials|default:0 }}</h4>
                            <small class="text-muted">Total Tutorials</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0">{{ total_students|default:0 }}</h4>
                            <small class="text-muted">Total Students</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript for tutorial form -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Free access and pricing controls
    const freeAccessCheckbox = document.getElementById('{{ form.free_access.id_for_label }}');
    const priceInput = document.getElementById('{{ form.price.id_for_label }}');
    
    // File upload previews
    const videoInput = document.getElementById('{{ form.video_file.id_for_label }}');
    const thumbnailInput = document.getElementById('{{ form.thumbnail.id_for_label }}');
    
    // Function to toggle price input based on free access
    function togglePriceInput() {
        if (freeAccessCheckbox && priceInput) {
            priceInput.disabled = freeAccessCheckbox.checked;
            if (freeAccessCheckbox.checked) {
                priceInput.value = '0';
                priceInput.closest('.mb-3').style.opacity = '0.5';
            } else {
                priceInput.closest('.mb-3').style.opacity = '1';
            }
        }
    }

    // Initial state
    if (freeAccessCheckbox) {
        togglePriceInput();
        freeAccessCheckbox.addEventListener('change', togglePriceInput);
    }
    
    // Video file preview
    if (videoInput) {
        videoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const preview = document.createElement('div');
                preview.className = 'mt-2 alert alert-info';
                preview.innerHTML = `
                    <i class="fas fa-video me-2"></i>
                    <strong>Video Selected:</strong> ${file.name}
                    <br><small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                `;
                
                // Remove existing preview
                const existing = videoInput.parentNode.querySelector('.video-preview');
                if (existing) existing.remove();
                
                preview.classList.add('video-preview');
                videoInput.parentNode.appendChild(preview);
            }
        });
    }
    
    // Thumbnail preview
    if (thumbnailInput) {
        thumbnailInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'mt-2';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Thumbnail Preview" 
                             style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 2px solid #ddd; object-fit: cover;">
                        <br><small class="text-muted">${file.name}</small>
                    `;
                    
                    // Remove existing preview
                    const existing = thumbnailInput.parentNode.querySelector('.thumbnail-preview');
                    if (existing) existing.remove();
                    
                    preview.classList.add('thumbnail-preview');
                    thumbnailInput.parentNode.appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    showFieldError(field, 'This field is required');
                    isValid = false;
                } else {
                    clearFieldError(field);
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                showNotification('Please fill in all required fields', 'error');
            }
        });
    }
    
    // Progress tracking
    updateFormProgress();
    
    // Auto-update progress on input changes
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('input', updateFormProgress);
        input.addEventListener('change', updateFormProgress);
    });
});

function showFieldError(field, message) {
    clearFieldError(field);
    
    const error = document.createElement('div');
    error.className = 'invalid-feedback d-block';
    error.textContent = message;
    
    field.classList.add('is-invalid');
    field.parentNode.appendChild(error);
}

function clearFieldError(field) {
    field.classList.remove('is-invalid');
    const existing = field.parentNode.querySelector('.invalid-feedback');
    if (existing) existing.remove();
}

function updateFormProgress() {
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
    let filled = 0;
    
    inputs.forEach(input => {
        if (input.value && input.value.trim() !== '') {
            filled++;
        }
    });
    
    const progress = inputs.length > 0 ? Math.round((filled / inputs.length) * 100) : 0;
    
    // Create or update progress bar
    let progressContainer = document.querySelector('.form-progress');
    if (!progressContainer) {
        progressContainer = document.createElement('div');
        progressContainer.className = 'form-progress mb-3';
        progressContainer.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">Form Completion</small>
                <small class="text-muted progress-text">${progress}%</small>
            </div>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success progress-bar-animated" style="width: ${progress}%"></div>
            </div>
        `;
        
        const formCard = document.querySelector('.card .card-body');
        if (formCard && formCard.firstChild) {
            formCard.insertBefore(progressContainer, formCard.firstChild);
        }
    } else {
        const progressBar = progressContainer.querySelector('.progress-bar');
        const progressText = progressContainer.querySelector('.progress-text');
        if (progressBar) progressBar.style.width = progress + '%';
        if (progressText) progressText.textContent = progress + '%';
    }
}

function previewTutorial() {
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    const title = formData.get('title') || 'Untitled Tutorial';
    const content = formData.get('content') || 'No content provided';
    const difficulty = formData.get('difficulty_level') || 'Not set';
    const isFree = formData.get('free_access') === 'on';
    const price = isFree ? 'Free' : '$' + (formData.get('price') || '0');
    
    // Show preview in a modal (using SweetAlert2 if available, otherwise alert)
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Tutorial Preview',
            html: `
                <div class="text-start">
                    <h5 class="text-primary">${title}</h5>
                    <p class="mt-3">${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</p>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Difficulty:</strong><br>
                            <span class="badge bg-info">${difficulty}</span>
                        </div>
                        <div class="col-6">
                            <strong>Price:</strong><br>
                            <span class="badge ${isFree ? 'bg-success' : 'bg-warning'}">${price}</span>
                        </div>
                    </div>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Continue Editing',
            width: '600px'
        });
    } else {
        alert(`Preview:\nTitle: ${title}\nContent: ${content.substring(0, 100)}...\nDifficulty: ${difficulty}\nPrice: ${price}`);
    }
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : (type === 'success' ? 'alert-success' : 'alert-info');
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>

<!-- Include SweetAlert2 for better modals -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock content %}